<?php

declare(strict_types=1);

/** @var Hyva\Theme\ViewModel\HyvaCsp $hyvaCsp */
/** @var Mondu\Mondu\Model\Ui\ConfigProvider $cfg */
/** @var \Magento\Framework\Escaper $escaper */
/** @var \Mondu\MonduPaymentHyva\Magewire\Checkout\Payment\Mondu $magewire */
?>
<script type="module">
    "use strict";

    let monduSdkPromise = null;

    function loadMonduSdk() {
        if (monduSdkPromise) {
            return monduSdkPromise;
        }

        monduSdkPromise = new Promise((resolve, reject) => {
            if (document.getElementById('mondu_sdk_min')) {
                return resolve();
            }

            const script = document.createElement('script');
            script.id = 'mondu_sdk_min';
            script.src = <?= json_encode($magewire->sdkUrl) ?>;
            script.async = true;
            script.onload = () => resolve();
            script.onerror = () => reject(new Error('Mondu SDK failed to load'));
            document.head.appendChild(script);
        });

        return monduSdkPromise;
    }

    let activeMethod = null;

    window.addEventListener('checkout:payment:method-activate', ({detail}) => {
        if (!detail.method?.startsWith('mondu')) {
            return;
        }

        activeMethod = detail.method;
        loadMonduSdk().catch(console.error);
    }, {once: true});
</script>
<?php $hyvaCsp->registerInlineScript(); ?>
